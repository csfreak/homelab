apiVersion: integreatly.org/v1alpha1
kind: Grafana
metadata:
  name: grafana
  namespace: monitoring
spec:
  config:
    auth:
      disable_signout_menu: true
    auth.anonymous:
      enabled: true
    log:
      level: warn
      mode: console
    security:
      admin_password: $GF_ADMIN_PASSWORD
      admin_user: $GF_ADMIN_USER
  dashboardLabelSelector:
    - matchExpressions:
        - key: app
          operator: In
          values:
            - grafana
  ingress:
    enabled: false
  database:
    type: mysql
    host: $GRAFANA_DB_SERVICE_HOST
    user: $MYSQL_USER
    password: $MYSQL_PASSWORD
  deployment:
    envFrom: 
    - secretRef:
        name: grafana-db-user
      prefix: MYSQL_
    - secretRef:
        name: grafana-admin
      prefix: GF_ADMIN_
---
apiVersion: integreatly.org/v1alpha1
kind: GrafanaDataSource
metadata:
  name: prometheus-grafanadatasource
  namespace: monitoring
spec:
  datasources:
    - access: proxy
      editable: false
      isDefault: false
      jsonData:
        timeInterval: 5s
        httpHeaderName1: Authorization
        tlsSkipVerify: true
      secureJsonData:
        httpHeaderValue1: "Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6IktMMUR3Zjdoem9hZGZQNjdjRHlsSlBuczZLSnN2cmlHTUpTNjFFdEktYUUifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJtb25pdG9yaW5nIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImdyYWZhbmEtc2VydmljZWFjY291bnQtdG9rZW4tYjJjeDkiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZ3JhZmFuYS1zZXJ2aWNlYWNjb3VudCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjExYTE5OTRjLTU4ZDItNDU5NS04NDI5LWIzYWVhNjI3ZDVhMCIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDptb25pdG9yaW5nOmdyYWZhbmEtc2VydmljZWFjY291bnQifQ.rU2Tze-slXEK-Tjg9FuZi_qYzsnkbNp1ft1kt55dIgE9WJblIOTHVki521sj4cCbLiioJWpLMSwom2TRi75nsZj0Jb_rHEQhgsUsHH_vCJzyJY0o_G1VHxQA34MZyEmDMlb1qH7BgLeIN1dBrO3bh2_yWbZdpubz-wcEhLF4JtV5978v4k6eoo4nBeoSdmFa0t3doVHvt_nW8wOhhHaEMDtBsXNWG7iDcxFXwMXNDJf4KVMeDwJ72uhHxa50Oalfm76doN0yJbxdViAdBdjh1vJUzUzlSP_zqmFOQGjAzKPI5zRGqCjubW0ZQg_Axf-bmlKMqeTN0F9vAOyNQYaUcA"
      name: Prometheus
      type: prometheus
      url: 'https://thanos-querier.openshift-monitoring.svc:9091'
      version: 1
  name: prometheus-datasource.yaml
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: grafana-cert
  namespace: monitoring
spec:
  secretName: grafana-cert
  commonName: grafana.monitoring.apps.homelab.csfreak.com
  issuerRef:
    name: letsencrypt
    kind: ClusterIssuer
  dnsNames:
    - grafana.monitoring.apps.homelab.csfreak.com
---
kind: Route
apiVersion: route.openshift.io/v1
metadata:
  name: grafana-route-custom
  namespace: monitoring
  annotations:
    cert-utils-operator.redhat-cop.io/certs-from-secret: grafana-cert
    cert-utils-operator.redhat-cop.io/inject-CA: 'false'
spec:
  host: grafana.monitoring.apps.homelab.csfreak.com
  path: /
  to:
    kind: Service
    name: grafana-service
    weight: 100
  port:
    targetPort: 3000
  tls:
    termination: edge
  wildcardPolicy: None
---
apiVersion: v1
kind: Secret
metadata:
  name: grafana-admin
type: Opaque

